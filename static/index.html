<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CPUNK DHT Peer & Traffic Monitor</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #050811;
      --bg-elevated: #0b1020;
      --bg-soft: #0f1628;
      --accent: #00f0ff;
      --accent-soft: rgba(0, 240, 255, 0.12);
      --accent2: #ff2cd8;
      --text: #f8fafc;
      --text-soft: #a5b4cc;
      --danger: #f97373;
      --success: #22c55e;
      --border: #1e293b;
      --card-radius: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000000 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    h1 {
      font-size: 1.4rem;
      margin: 0;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .tagline {
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(6px);
      white-space: nowrap;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--text-soft);
    }
    .pill-dot.live {
      animation: pulse 1.5s infinite;
      background: var(--accent);
    }
    .pill-dot.ok {
      background: var(--success);
    }
    .pill-dot.idle {
      background: #eab308;
    }
    .pill-dot.cold {
      background: var(--text-soft);
    }
    .pill-dot.down {
      background: var(--danger);
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.4); opacity: 0.4; }
      100% { transform: scale(1); opacity: 1; }
    }

    .timeframe-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .timeframe-label {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-right: 4px;
    }

    .timeframe-btn {
      padding: 4px 10px;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-soft);
      cursor: pointer;
      transition: all 0.15s ease-out;
    }

    .timeframe-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .timeframe-btn.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
    }

    /* Layout */

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid-2 {
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
    }

    .grid-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    @media (max-width: 900px) {
      .grid-2 {
        grid-template-columns: minmax(0, 1fr);
      }
      .grid-3 {
        grid-template-columns: minmax(0, 1fr);
      }

      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .timeframe-controls {
        justify-content: flex-start;
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(2, 6, 23, 0.98));
      border-radius: var(--card-radius);
      padding: 14px 16px;
      border: 1px solid rgba(30, 64, 175, 0.4);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.8);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    .card-subtitle {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .metric-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .metric-pill {
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 0.74rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      color: var(--text-soft);
    }

    .metric-pill strong {
      color: var(--text);
    }

    .metric-pill.accent strong {
      color: var(--accent);
    }

    .metric-pill.danger strong {
      color: var(--danger);
    }

    canvas {
      width: 100% !important;
      height: 220px !important;
    }

    /* Top talkers table */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th, td {
      padding: 6px 6px;
      text-align: left;
    }

    th {
      font-weight: 600;
      color: var(--text-soft);
      border-bottom: 1px solid var(--border);
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.7);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.4);
    }

    td {
      border-bottom: 1px solid rgba(15, 23, 42, 0.4);
    }

    .ip-cell {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
    }


    /* Heatmap */
    
    .heatmap-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      table-layout: fixed;
    }
    
    .heatmap-table th,
    .heatmap-table td {
      padding: 4px 3px;
      text-align: center;
      border: 1px solid rgba(30, 41, 59, 0.4);
    }
    
    .heatmap-table th {
      font-weight: 500;
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
    }
    
    .heatmap-table td {
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
    }
    
    .heatmap-table td.empty {
      background: rgba(15, 23, 42, 0.4);
      color: var(--text-soft);
    }
    
    .heatmap-legend {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .heatmap-legend-bar {
      flex: 1;
      max-width: 200px;
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(
        to right,
        rgba(15, 23, 42, 0.7),
        rgba(56, 189, 248, 0.3),
        rgba(0, 240, 255, 0.75)
      );
    }
    
    .heatmap-legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-soft);
    }
    
    







    /* Footer */

    footer {
      margin-top: 18px;
      font-size: 0.75rem;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title-block">
        <div class="title-row">
          <h1>CPUNK DHT Peer &amp; Traffic Monitor</h1>
        </div>
        <div class="badge-row">
          <div class="badge" id="health-pill">
            <span class="pill-dot cold" id="health-dot"></span>
            <span id="health-label">HEALTH: cold</span>
          </div>
          <div class="badge">
            <span class="pill-dot live"></span>
            <span>LIVE</span>
          </div>
          <div class="badge" id="host-pill">
            <span id="host-label">Host: …</span>
          </div>
          <div class="badge" id="iface-pill">
            <span id="iface-label">iface: … / port: …</span>
          </div>
        </div>
      </div>

      <div class="timeframe-controls">
        <span class="timeframe-label">Timeframe:</span>
        <button class="timeframe-btn active" data-range="1h">1h</button>
        <button class="timeframe-btn" data-range="6h">6h</button>
        <button class="timeframe-btn" data-range="24h">24h</button>
        <button class="timeframe-btn" data-range="7d">7d</button>
      </div>
    </header>

    <!-- Top summary cards -->
    <div class="grid grid-3">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Current window</div>
            <div class="card-subtitle" id="last-ts">Last update: &mdash;</div>
          </div>
        </div>
        <div class="metric-row">
          <div class="metric-pill accent">
            Peers: <strong id="summary-peers">0</strong>
          </div>
          <div class="metric-pill">
            Packets: <strong id="summary-pkts">0</strong>
          </div>
          <div class="metric-pill">
            Traffic: <strong id="summary-bytes">0 B</strong>
          </div>
          <div class="metric-pill">
            IN: <strong id="summary-in">0 B</strong>
          </div>
          <div class="metric-pill">
            OUT: <strong id="summary-out">0 B</strong>
          </div>
        </div>
        <div class="metric-row">
          <div class="metric-pill">
            New peers: <strong id="summary-new">0</strong>
          </div>
          <div class="metric-pill">
            Expired peers: <strong id="summary-expired">0</strong>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Host system</div>
            <div class="card-subtitle">CPU, memory, disk</div>
          </div>
        </div>
        <div class="metric-row">
          <div class="metric-pill">
            CPU: <strong id="sys-cpu">0%</strong>
          </div>
          <div class="metric-pill">
            RAM: <strong id="sys-mem">0 / 0 MB</strong>
          </div>
          <div class="metric-pill">
            Disk: <strong id="sys-disk">0% used</strong>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">dna-nodus</div>
            <div class="card-subtitle">Process status on this host</div>
          </div>
        </div>
        <div class="metric-row">
          <div class="metric-pill" id="nodus-running-pill">
            Running: <strong id="nodus-running">no</strong>
          </div>
          <div class="metric-pill">
            CPU: <strong id="nodus-cpu">–</strong>
          </div>
          <div class="metric-pill">
            RAM: <strong id="nodus-mem">–</strong>
          </div>
          <div class="metric-pill">
            Uptime: <strong id="nodus-uptime">–</strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts row -->
    <div class="grid grid-2" style="margin-top:16px;">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Peers &amp; throughput</div>
            <div class="card-subtitle">Unique peers &amp; total bytes per window</div>
          </div>
        </div>
        <canvas id="peersChart"></canvas>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Direction &amp; churn</div>
            <div class="card-subtitle">IN vs OUT bytes, new vs expired peers</div>
          </div>
        </div>
        <canvas id="directionChart"></canvas>
      </div>
    </div>

    <!-- Top talkers & Heatmap -->
    <div class="grid grid-2" style="margin-top:16px;">
      <!-- Top talkers -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Top talkers (latest window)</div>
            <div class="card-subtitle">UDP sources by bytes on DHT port</div>
          </div>
          <div class="card-subtitle" id="db-info"></div>
        </div>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>IP</th>
                <th>Bytes</th>
                <th>Packets</th>
              </tr>
            </thead>
            <tbody id="top-talkers-body">
              <tr>
                <td colspan="4" style="text-align:center;color:var(--text-soft);padding:10px;">
                  No data yet (waiting for capture windows)…
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    
      <!-- Hourly peers heatmap -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Hourly peers heatmap</div>
            <div class="card-subtitle">Last 7 days · max unique peers per hour</div>
          </div>
        </div>
        <div style="overflow-x:auto;">
          <table class="heatmap-table" id="peers-heatmap-table">
            <thead>
              <tr>
                <th>Day</th>
                <!-- 0–23 hours header -->
                <th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
                <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th>
                <th>12</th><th>13</th><th>14</th><th>15</th><th>16</th><th>17</th>
                <th>18</th><th>19</th><th>20</th><th>21</th><th>22</th><th>23</th>
              </tr>
            </thead>
            <tbody id="peers-heatmap-body">
              <tr>
                <td colspan="25" style="text-align:center;color:var(--text-soft);padding:10px;">
                  No data yet…
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="heatmap-legend">
          <div class="heatmap-legend-bar"></div>
          <div class="heatmap-legend-labels" id="heatmap-legend-labels">
            <span>0 peers</span>
            <span id="heatmap-max-label">&gt; 0 peers</span>
          </div>
        </div>
      </div>
    </div>



    <footer>
      <div id="footer-left">
        CPUNK DHT Monitor &mdash; FastAPI + tshark
      </div>
      <div id="footer-right">
        <span id="last-refresh">Last refresh: &mdash;</span>
      </div>
    </footer>
  </div>

  <script>
    // --- Global state ---

    let fullHistory = [];
    let latestTop = [];
    let healthInfo = null;
    let configInfo = null;
    let dbStats = null;

    let currentRange = "1h";

    const RANGE_SECONDS = {
      "1h": 3600,
      "6h": 6 * 3600,
      "24h": 24 * 3600,
      "7d": 7 * 24 * 3600,
    };

    // --- Helpers ---

    function formatBytes(bytes) {
      if (bytes == null) return "0 B";
      const units = ["B", "KB", "MB", "GB", "TB"];
      let i = 0;
      let val = bytes;
      while (val >= 1024 && i < units.length - 1) {
        val /= 1024;
        i++;
      }
      return val.toFixed(i === 0 ? 0 : 1) + " " + units[i];
    }

    function formatPercent(x) {
      if (x == null) return "–";
      return x.toFixed(1) + "%";
    }

    function formatDuration(seconds) {
      if (seconds == null) return "–";
      seconds = Math.floor(seconds);
      if (seconds < 60) return seconds + "s";
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      if (m < 60) return m + "m " + s + "s";
      const h = Math.floor(m / 60);
      const mm = m % 60;
      if (h < 24) return h + "h " + mm + "m";
      const d = Math.floor(h / 24);
      const hh = h % 24;
      return d + "d " + hh + "h";
    }

    function formatTs(ts) {
      if (!ts) return "—";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return ts;
      return d.toLocaleString();
    }

    function formatTsShort(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return ts;
      return d.toLocaleTimeString();
    }

    function applyRange(history) {
      if (!history || history.length === 0) return [];
      const maxAgeSec = RANGE_SECONDS[currentRange];
      if (!maxAgeSec) return history;
      const now = Date.now();
      const maxAgeMs = maxAgeSec * 1000;
      return history.filter(point => {
        const t = Date.parse(point.ts);
        if (isNaN(t)) return true;
        return (now - t) <= maxAgeMs;
      });
    }

    // --- Timeframe buttons ---

    document.querySelectorAll(".timeframe-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const range = btn.getAttribute("data-range");
        if (!range) return;
        currentRange = range;
        document
          .querySelectorAll(".timeframe-btn")
          .forEach(b => b.classList.toggle("active", b === btn));
        updateCharts();
      });
    });

    // --- Charts ---

    let peersChart = null;
    let directionChart = null;

    function initCharts() {
      const peersCtx = document.getElementById("peersChart").getContext("2d");
      const directionCtx = document.getElementById("directionChart").getContext("2d");

      peersChart = new Chart(peersCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Unique peers",
              data: [],
              yAxisID: "yPeers",
              tension: 0.2,
            },
            {
              label: "Total bytes",
              data: [],
              yAxisID: "yBytes",
              tension: 0.2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                color: "#94a3b8",
                maxRotation: 0,
                autoSkipPadding: 8,
              },
              grid: { color: "rgba(30,41,59,0.6)" },
            },
            yPeers: {
              position: "left",
              ticks: { color: "#94a3b8" },
              grid: { color: "rgba(30,41,59,0.4)" },
            },
            yBytes: {
              position: "right",
              ticks: {
                color: "#94a3b8",
                callback: (value) => formatBytes(value),
              },
              grid: { display: false },
            },
          },
          plugins: {
            legend: {
              labels: { color: "#e2e8f0", usePointStyle: true },
            },
          },
        },
      });

      directionChart = new Chart(directionCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "IN bytes",
              data: [],
              tension: 0.2,
            },
            {
              label: "OUT bytes",
              data: [],
              tension: 0.2,
            },
            {
              label: "New peers",
              data: [],
              tension: 0.2,
            },
            {
              label: "Expired peers",
              data: [],
              tension: 0.2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: "#94a3b8", maxRotation: 0, autoSkipPadding: 8 },
              grid: { color: "rgba(30,41,59,0.6)" },
            },
            y: {
              ticks: { color: "#94a3b8" },
              grid: { color: "rgba(30,41,59,0.4)" },
            },
          },
          plugins: {
            legend: {
              labels: { color: "#e2e8f0", usePointStyle: true },
            },
          },
        },
      });
    }

    function updateCharts() {
      if (!peersChart || !directionChart) return;

      const history = applyRange(fullHistory);
      const labels = history.map(p => formatTsShort(p.ts));

      // Peers & traffic
      peersChart.data.labels = labels;
      peersChart.data.datasets[0].data = history.map(p => p.unique_peers || 0);
      peersChart.data.datasets[1].data = history.map(p => p.total_bytes || 0);
      peersChart.update("none");

      // Direction & churn
      directionChart.data.labels = labels;
      directionChart.data.datasets[0].data = history.map(p => p.in_bytes || 0);
      directionChart.data.datasets[1].data = history.map(p => p.out_bytes || 0);
      directionChart.data.datasets[2].data = history.map(p => p.new_peers || 0);
      directionChart.data.datasets[3].data = history.map(p => p.expired_peers || 0);
      directionChart.update("none");
    }

    // --- UI updates ---

    function updateSummary() {
      if (!fullHistory || fullHistory.length === 0) return;
      const last = fullHistory[fullHistory.length - 1];

      document.getElementById("last-ts").textContent =
        "Last update: " + formatTs(last.ts);

      document.getElementById("summary-peers").textContent = last.unique_peers ?? 0;
      document.getElementById("summary-pkts").textContent = last.total_packets ?? 0;
      document.getElementById("summary-bytes").textContent = formatBytes(last.total_bytes || 0);
      document.getElementById("summary-in").textContent = formatBytes(last.in_bytes || 0);
      document.getElementById("summary-out").textContent = formatBytes(last.out_bytes || 0);
      document.getElementById("summary-new").textContent = last.new_peers ?? 0;
      document.getElementById("summary-expired").textContent = last.expired_peers ?? 0;

      // System metrics from last window
      document.getElementById("sys-cpu").textContent =
        formatPercent(last.cpu_usage ?? 0);
      const memUsed = last.mem_used_mb ?? 0;
      const memTotal = last.mem_total_mb ?? 0;
      document.getElementById("sys-mem").textContent =
        memUsed.toFixed(0) + " / " + memTotal.toFixed(0) + " MB";
      const diskPct = last.disk_used_pct ?? 0;
      document.getElementById("sys-disk").textContent =
        diskPct.toFixed(1) + "% used";
    }

    function updateTopTalkers() {
      const tbody = document.getElementById("top-talkers-body");
      tbody.innerHTML = "";

      if (!latestTop || latestTop.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.style.textAlign = "center";
        td.style.color = "var(--text-soft)";
        td.style.padding = "10px";
        td.textContent = "No packets captured yet on DHT port.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      latestTop.forEach((peer, idx) => {
        const tr = document.createElement("tr");

        const tdRank = document.createElement("td");
        tdRank.textContent = idx + 1;

        const tdIp = document.createElement("td");
        tdIp.textContent = peer.ip || "?";
        tdIp.className = "ip-cell";

        const tdBytes = document.createElement("td");
        tdBytes.textContent = formatBytes(peer.bytes || 0);

        const tdPkts = document.createElement("td");
        tdPkts.textContent = peer.packets ?? 0;

        tr.appendChild(tdRank);
        tr.appendChild(tdIp);
        tr.appendChild(tdBytes);
        tr.appendChild(tdPkts);
        tbody.appendChild(tr);
      });
    }

    function updateHealthAndConfig() {
      const healthDot = document.getElementById("health-dot");
      const healthLabel = document.getElementById("health-label");

      if (healthInfo) {
        const status = healthInfo.status || "cold";
        healthLabel.textContent = "HEALTH: " + status.toUpperCase();

        healthDot.className = "pill-dot";
        if (status === "ok") healthDot.classList.add("ok");
        else if (status === "idle") healthDot.classList.add("idle");
        else if (status === "cold") healthDot.classList.add("cold");
        else healthDot.classList.add("down");

        // dna-nodus info
        const running = healthInfo.nodus_running === 1;
        document.getElementById("nodus-running").textContent = running ? "yes" : "no";

        const runningPill = document.getElementById("nodus-running-pill");
        runningPill.classList.remove("danger");
        if (!running) runningPill.classList.add("danger");

        document.getElementById("nodus-cpu").textContent =
          healthInfo.nodus_cpu_pct != null
            ? healthInfo.nodus_cpu_pct.toFixed(1) + "%"
            : "–";

        document.getElementById("nodus-mem").textContent =
          healthInfo.nodus_mem_mb != null
            ? healthInfo.nodus_mem_mb.toFixed(1) + " MB"
            : "–";

        document.getElementById("nodus-uptime").textContent =
          formatDuration(healthInfo.nodus_uptime_seconds);
      }

      if (configInfo) {
        document.getElementById("host-label").textContent =
          "Host: " + (configInfo.hostname || "unknown");
        document.getElementById("iface-label").textContent =
          "iface: " + (configInfo.iface || "?") +
          " / port: " + (configInfo.port || "?");
      }

      if (dbStats) {
        const { rows, oldest_ts, newest_ts } = dbStats;
        const text = rows
          ? `${rows} rows in DB · ${formatTsShort(oldest_ts)} → ${formatTsShort(newest_ts)}`
          : "DB empty";
        document.getElementById("db-info").textContent = text;
      }
    }

    function updateFooter() {
      document.getElementById("last-refresh").textContent =
        "Last refresh: " + new Date().toLocaleTimeString();
    }

    // --- Heatmap: hourly peers for last 7 days ---
    
    function buildHourlyHeatmap(history) {
      const buckets = new Map(); // dayKey -> { label, values: [24] }
      let maxPeers = 0;
    
      history.forEach(point => {
        if (!point.ts) return;
        const d = new Date(point.ts);
        if (isNaN(d.getTime())) return;
    
        const dayKey = d.toISOString().slice(0, 10); // YYYY-MM-DD
        const hour = d.getHours();
        const peers = point.unique_peers || 0;
    
        if (!buckets.has(dayKey)) {
          const label =
            d.toLocaleDateString(undefined, { month: "short", day: "numeric" }) +
            " (" +
            d.toLocaleDateString(undefined, { weekday: "short" }) +
            ")";
          buckets.set(dayKey, {
            label,
            values: new Array(24).fill(0),
          });
        }
    
        const bucket = buckets.get(dayKey);
        // Use max peers in that hour
        if (peers > bucket.values[hour]) {
          bucket.values[hour] = peers;
        }
        if (peers > maxPeers) {
          maxPeers = peers;
        }
      });
    
      // Sort by day ascending, then take last 7
      const sortedDays = Array.from(buckets.entries())
        .sort((a, b) => (a[0] < b[0] ? -1 : 1))
        .slice(-7);
    
      const days = sortedDays.map(([key, val]) => val);
      return { days, maxPeers };
    }
    
    function intensityColor(value, max) {
      if (!max || !value) {
        // "empty" cell
        return null;
      }
      let t = value / max;
      if (t < 0) t = 0;
      if (t > 1) t = 1;
    
      // We'll do a teal-ish scale from dark to bright
      const baseOpacity = 0.15;
      const opacity = baseOpacity + t * 0.85;
    
      // constant teal color
      return `rgba(0, 240, 255, ${opacity})`;
    }
    
    function updateHeatmap() {
      const tbody = document.getElementById("peers-heatmap-body");
      const legendMaxLabel = document.getElementById("heatmap-max-label");
    
      if (!tbody) return;
    
      tbody.innerHTML = "";
    
      const { days, maxPeers } = buildHourlyHeatmap(fullHistory || []);
    
      if (!days || days.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 25;
        td.style.textAlign = "center";
        td.style.color = "var(--text-soft)";
        td.style.padding = "10px";
        td.textContent = "No data yet…";
        tr.appendChild(td);
        tbody.appendChild(tr);
    
        legendMaxLabel.textContent = "> 0 peers";
        return;
      }
    
      days.forEach(day => {
        const tr = document.createElement("tr");
    
        const labelTd = document.createElement("td");
        labelTd.textContent = day.label;
        labelTd.style.whiteSpace = "nowrap";
        labelTd.style.position = "sticky";
        labelTd.style.left = "0";
        labelTd.style.background = "rgba(15,23,42,0.95)";
        labelTd.style.zIndex = "1";
        tr.appendChild(labelTd);
    
        for (let hour = 0; hour < 24; hour++) {
          const value = day.values[hour] || 0;
          const td = document.createElement("td");
          td.textContent = value > 0 ? value : "";
          if (value === 0) {
            td.classList.add("empty");
          } else {
            const color = intensityColor(value, maxPeers);
            if (color) {
              td.style.backgroundColor = color;
            }
          }
          tr.appendChild(td);
        }
    
        tbody.appendChild(tr);
      });
    
      legendMaxLabel.textContent = "> " + maxPeers + " peers";
    }




    // --- Fetch logic ---

    async function fetchJson(path) {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) {
        throw new Error(`${path} returned ${res.status}`);
      }
      return await res.json();
    }

    async function refreshAll() {
      try {
        const [metrics, health, config, db] = await Promise.all([
          fetchJson("/metrics.json"),
          fetchJson("/health"),
          fetchJson("/config.json"),
          fetchJson("/db_stats"),
        ]);

        fullHistory = metrics.history || [];
        latestTop = metrics.latest_top || [];
        healthInfo = health;
        configInfo = config;
        dbStats = db;

        updateSummary();
        updateCharts();
        updateHeatmap();
        updateTopTalkers();
        updateHealthAndConfig();
        updateFooter();
      } catch (err) {
        console.error("Failed to refresh metrics:", err);
      }
    }

    // --- Init ---

    window.addEventListener("DOMContentLoaded", () => {
      initCharts();
      refreshAll();
      // Poll every INTERVAL_SECONDS * 2 (roughly)
      setInterval(refreshAll, 30000);
    });
  </script>
</body>
</html>
